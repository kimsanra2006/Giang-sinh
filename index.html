<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christmas Gifts & Lights</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000000; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { width: 100%; height: 100vh; display: block; }
        
        #ui-layer {
            position: absolute; bottom: 30px; width: 100%;
            text-align: center; pointer-events: none; z-index: 100;
        }
        
        .badge {
            display: inline-block; background: rgba(0,0,0,0.7);
            border: 2px solid #FFD700; color: #FFD700;
            padding: 10px 25px; border-radius: 50px;
            font-size: 18px; font-weight: bold; margin-bottom: 10px;
        }

        button {
            pointer-events: auto; cursor: pointer;
            background: linear-gradient(to bottom, #D32F2F, #8B0000); 
            color: #FFF; border: 2px solid #FFD700;
            padding: 15px 50px; border-radius: 30px; 
            font-weight: 800; font-size: 16px;
        }

        /* --- KHUNG TO G·∫§P ƒê√îI --- */
        #camera-preview {
            position: absolute; top: 15px; right: 15px;
            width: 320px; height: 240px; 
            border: 2px solid rgba(255,215,0,0.5); 
            transform: scaleX(-1); 
            border-radius: 8px;
            background: #000;
            /* Gi√∫p h√¨nh ·∫£nh b√™n trong co gi√£n kh√≠t khung */
            object-fit: cover; 
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="ui-layer">
        <div id="status" class="badge">üéÑ Giang Sinh An Lanh üéÑ</div>
        <br>
        <button id="btnStart" onclick="startSystem()">B·∫ÆT ƒê·∫¶U</button>
    </div>

    <div id="canvas-container"></div>
    <video class="input_video" style="display:none"></video>
    <canvas id="camera-preview"></canvas>

    <script>
        const loader = new THREE.TextureLoader();
        const photoFiles = ['./image1.jpeg', './image2.jpeg', './image3.jpeg', './image4.jpeg', './image5.jpeg'];
        const photoTextures = [];

        // S·ª¨A L·ªñI ·∫¢NH 1-5 KH√îNG M√âO
        photoFiles.forEach((f, i) => {
            loader.load(f, (texture) => {
                const img = texture.image;
                const aspect = img.width / img.height;
                if (aspect > 1) {
                    texture.repeat.set(1 / aspect, 1);
                    texture.offset.set((1 - 1 / aspect) / 2, 0);
                } else {
                    texture.repeat.set(1, aspect);
                    texture.offset.set(0, (1 - aspect) / 2);
                }
                photoTextures[i] = texture;
            });
        });

        // (Gi·ªØ nguy√™n logic t·∫°o h·∫°t v√† c·∫£nh 3D c·ªßa b·∫°n)
        function createCustomTexture(type) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            if (type === 'gold_glow') {
                const grd = ctx.createRadialGradient(64,64,0,64,64,40);
                grd.addColorStop(0,'#FFF'); grd.addColorStop(0.5,'#FFD700'); grd.addColorStop(1,'transparent');
                ctx.fillStyle = grd; ctx.fillRect(0,0,128,128);
            } else {
                ctx.fillStyle = '#D32F2F'; ctx.fillRect(20,20,88,88);
            }
            return new THREE.CanvasTexture(canvas);
        }

        const textures = { gold: createCustomTexture('gold_glow'), red: createCustomTexture('gold_glow'), gift: createCustomTexture('gift_red') };
        const CONFIG = { goldCount: 2000, redCount: 300, giftCount: 150, explodeRadius: 65, photoOrbitRadius: 25, treeHeight: 70, treeBaseRadius: 35 };

        let scene, camera, renderer, groupGold, groupRed, groupGift, photoMeshes = [], state = 'TREE', handX = 0.5;

        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 100;
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            groupGold = createSystem('gold', CONFIG.goldCount, 2.0);
            groupRed = createSystem('gold', CONFIG.redCount, 3.5);
            groupGift = createSystem('gift', CONFIG.giftCount, 3.0);
            const geo = new THREE.PlaneGeometry(10, 10);
            for(let i=0; i<5; i++) {
                const mesh = new THREE.Mesh(geo, new THREE.MeshBasicMaterial({ side: 2, transparent: true }));
                mesh.visible = false; scene.add(mesh); photoMeshes.push(mesh);
            }
            animate();
        }

        function createSystem(type, count, size) {
            const pPos = [], pTree = [], pExplode = [];
            for(let i=0; i<count; i++) {
                const h = Math.random() * CONFIG.treeHeight;
                const r = (1 - (h/CONFIG.treeHeight)) * CONFIG.treeBaseRadius * Math.sqrt(Math.random());
                pTree.push(r * Math.cos(i), h - 35, r * Math.sin(i));
                const rad = CONFIG.explodeRadius * Math.cbrt(Math.random());
                pExplode.push(rad * Math.sin(i) * Math